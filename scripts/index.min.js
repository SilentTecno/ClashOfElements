var game=(function(){var b=this;function a(){b=this;this.canvas=null;this.bodyElement=null;this.step=40;this.buildings_on_stage=22;this.max_player_bullets=5;this.CPU=null;this.sound=null;this.init=function(c){this.bodyElement=dq("body")[0];this.CPU=new a.CPU();this.canvas=this.initCanvas(c,this.CPU);this.canvas.players=this.initPlayers();this.sound=new a.sound();this.initBuildings();this.canvas.showPresentation();this.bindPresentation()};this.initCanvas=function(e,d){var c=new a.canvas();c.init({canvasId:e.canvasId,canvasWrapper:e.canvasWrapper,step:this.step,cpu:d});return c};this.initPlayers=function(){var c=[],e=new a.player({name:"1"});e.setKeys({earth:81,water:87,air:69,fire:82});e.init({x:0,y:0,width:60,height:this.step,fill:"#FFF",border:"#000",limits:{x:this.canvas.x,y:this.canvas.y},imageSrc:"images/player.png",angle:45});e.cursor=new a.cursor();c.push(e);var d=new a.player({name:"2"});d.setKeys({earth:81,water:87,air:69,fire:82});d.init({x:this.canvas.x-this.step,y:this.canvas.y-this.step,width:60,height:this.step,fill:"#000",border:"#FFF",limits:{x:this.canvas.x,y:this.canvas.y},imageSrc:"images/player.png",angle:-135});c.push(d);return c};this.initBuildings=function(){for(var g in this.canvas.players){if(!isNaN(g)){var e=1,k=0;base=3;for(var f=0;f<(this.buildings_on_stage/2);f++){var h=Math.floor((Math.random()*2)+(2*g));var c=new a.building({type:a.element.types[h]});c.typeNumber=h;var d=this.canvas.players[g];if(Number(g)==0){c.init({x:(2*d.width)+(2*d.width*f)-((2*base+k)*d.width*k),y:(2*d.height)+(2*d.height*k),width:this.step,height:this.step,parent:g,imageSrc:"images/builds.png"})}else{c.init({x:(this.canvas.x-d.width)-((2*d.width)+(2*d.width*f))+((2*base+k)*d.width*k),y:(this.canvas.y-d.height)-(2*d.height)-(2*d.height*k),width:this.step,height:this.step,parent:g,imageSrc:"images/builds.png"})}this.canvas.players[g].buildings.push(c);if(e++==base){base--;k++;e=1}}}}};this.bindEvents=function(){this.bodyElement.onkeydown=this.keysManagment;this.bodyElement.onmousemove=this.mouseMoveManagement};this.keysManagment=function(d){if(d.keyCode==87||d.keyCode==82){var c=false,f={event:d,_maxAmmo:b.max_player_bullets};c=b.canvas.players[0].onKeyDown(f);if(c&&c===true&&typeof c==="boolean"){var e="shoot"+((d.keyCode==87)?"Water":"Fire");if(b.canvas.animatable===false){b.canvas.animatable=true;b.canvas.animate(true)}}}};this.mouseMoveManagement=function(c){var d=b.canvas.players[0];d.onMouseMove(b.getMousePosition(c));d.getAngle(d.getCursor().x,d.getCursor().y);b.canvas.draw(false)};this.getMousePosition=function(c){return{x:(c.clientX||c.pageX)-this.canvas.canvasElement.offsetLeft,y:(c.clientY||c.pageY)-this.canvas.canvasElement.offsetTop}};this.bindPresentation=function(c){this.bodyElement.onclick=function(){b.bindEvents();b.canvas.draw();b.sound.init();b.CPU.start({canvas:b.canvas,initial_timer:4500,final_timer:500,refresh:28000,maxAmmo:b.max_player_bullets,sound:b.sound})}}}return a})();game.common={getBrowserLimits:function(){var d=document.documentElement,c=dq("body")[0],a=window.innerWidth||d.clientWidth||c.clientWidth,b=window.innerHeight||d.clientHeight||c.clientHeight;return{width:a,height:b}}};window.requestAnimFrame=(function(a){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(b){window.setTimeout(b,1000/60)}})();var dq=(function(){function a(c){var b=null;if(c&&typeof c==="string"){if(c.length>1){if(c[0]==="#"){b=c.substring(1,c.length);return document.getElementById(b)}else{if(c[0]==="."){b=c.substring(1,c.length);return document.getElementsByClassName(b)}else{return document.getElementsByTagName(c)}}}else{if(c.length>0){return document.getElementsByTagName(c)}}}}return a})();var GUID=(function(){function a(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}return function(){return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}})();dq.grep=function(a,h,e){var g,d=[],b=0,c=a.length,f=!e;for(;b<c;b++){g=!h(a[b],b);if(g!==f){d.push(a[b])}}return d};game.shape=(function(){function a(){this.limits={x:null,y:null}}a.prototype.x=null;a.prototype.y=null;a.prototype.width=null;a.prototype.height=null;a.prototype.fill=null;a.prototype.fillGradient=null;a.prototype.border=null;a.prototype.limits=null;a.prototype.imageSrc=null;a.prototype.image=null;a.prototype.angle=0;a.prototype.parent=null;a.prototype.id=null;a.prototype.init=function(b){if(b){if(b.x||b.x==0){this.x=b.x}if(b.y||b.y==0){this.y=b.y}if(b.width){this.width=b.width}if(b.height){this.height=b.height}if(b.fill){this.fill=b.fill}if(b.border){this.border=b.border}if(b.limits){this.limits=b.limits}if(b.imageSrc){this.imageSrc=b.imageSrc}if(b.angle||b.angle==0){this.angle=b.angle}if(b.parent){this.parent=b.parent}if(b.fillGradient){this.fillGradient=b.fillGradient}this.id=GUID()}};a.prototype.getImage=function(){if(!this.image){this.image=new Image();this.image.src=this.imageSrc}return this.image};a.prototype.getAngle=function(c,b){if(c&&b){this.angle=Math.atan2(b-this.y,c-this.x)*180/Math.PI}return this.angle};return a})();game.cursor=(function(a){b.prototype=new game.shape();b.prototype.constructor=b;function b(){this.x=0;this.y=0}return b})(game.shape);game.player=(function(b){a.prototype=new game.shape();a.prototype.constructor=a;function a(c){if(c){if(c.name){this.name=c.name}}this.cursor=new game.cursor();this.keys=new game.keySet();this.bullets=[];this.buildings=[];this.score=0}a.prototype.name=null;a.prototype.keys=null;a.prototype.cursor=null;a.prototype.bullets=null;a.prototype.buildings=null;a.prototype.score=null;a.prototype.init=function(c){b.prototype.init.call(this,c)};a.prototype.setKeys=function(c){this.keys=new game.keySet();this.keys.earth=c.earth;this.keys.water=c.water;this.keys.air=c.air;this.keys.fire=c.fire};a.prototype.onKeyDown=function(g){g.event=g.event||window.event;var f=g.event.keyCode||g.event.which,c=false,d=null,e=null;switch(f){case this.keys.earth:e="earth";break;case this.keys.water:e="water";break;case this.keys.fire:e="fire";break;case this.keys.air:e="air";break}if(this.bullets.length<g._maxAmmo&&e){d=new game.bullet({type:e});d.init({x:this.x,y:this.y,width:this.height,height:this.height,fill:game.element[e].fill,fillGradient:game.element[e].fillGradient,border:game.element[e].border,origin:{x:this.x,y:this.y},target:{x:this.cursor.x,y:this.cursor.y},limits:{x:this.limits.x,y:this.limits.y},parent:this,type:e,speed:(Math.floor(Math.random()*10)+1)});this.bullets.push(d);console.log(d.speed);c=true}return c};a.prototype.onMouseMove=function(c){if(c){if(c.x){this.cursor.x=c.x}if(c.y){this.cursor.y=c.y}return true}return false};a.prototype.getCursor=function(c){return this.cursor};return a})(game.shape);game.keySet=(function(){function a(){this.earth=null;this.water=null;this.air=null;this.fire=null}return a})();game.element=(function(b){a.prototype=new game.shape();a.prototype.constructor=a;function a(c){if(c){if(c.type){this.type=c.type}}}a.prototype.type=null;a.prototype.init=function(c){b.prototype.init.call(this,c);if(c){if(c.type){this.type=c.type}}};a.earth={fill:"#7c4f37",border:"#000000",fillGradient:["#D08787","#7F4343"]};a.water={fill:"#022bff",border:"#000000",fillGradient:["#8080FF","#0101B0"]};a.air={fill:"#5ce3e3",border:"#000000",fillGradient:["#ABABAB","#555555"]};a.fire={fill:"#ff0202",border:"#000000",fillGradient:["#FE9A2E","#FE2E2E"]};a.types=["water","fire","earth","air"];return a})(game.shape);game.bullet=(function(b){a.prototype=new game.shape();a.prototype.constructor=a;a.prototype.origin=null;a.prototype.target=null;a.prototype.direction=null;a.prototype.speed=null;function a(){this.origin={x:0,y:0};this.target={x:0,y:0};this.direction={x:0,y:0}}a.prototype.init=function(c){b.prototype.init.call(this,c);if(c){if(c.origin){this.origin=c.origin}if(c.target){this.target=c.target}if(c.speed){this.speed=c.speed}}this.calculateDirection()};a.prototype.calculateDirection=function(){var d=this.getAngle(this.target.x,this.target.y),c=d*Math.PI/180;this.direction.x=Math.cos(c);this.direction.y=Math.sin(c)};a.prototype.move=function(c){var c=c?c:(this.speed?this.speed:1),f=this.x+(this.direction.x*c),e=this.y+(this.direction.y*c),d=false;if((f>=0&&f<=this.limits.x)&&(e>=0&&e<this.limits.y)){if(f<=this.limits.x){this.x=f}if(e<=this.limits.y){this.y=e}d=true}else{d=false}return d};return a})(game.element);game.building=(function(b){a.prototype=new game.element();a.prototype.constructor=a;function a(c){if(c){if(c.type){this.type=c.type}}}return a})(game.element);game.canvas=(function(){var d=d,a=null;function b(){this.canvasElement=null;this.x=null;this.y=null;this.players=null;this.elements=null;this.cursor=null;this.animatable=false;this.collisionHelper=null;this.cpu=null;this.init=function(j){d=this;d.canvasElement=dq("#"+j.canvasId);d.expand(j.canvasWrapper,j.step);d.x=d.canvasElement.width;d.y=d.canvasElement.height;d.players=[];d.elements=[];d.cpu=j.cpu;a=d.canvasElement.getContext("2d");d.collisionHelper=new game.collisionHelper()};this.draw=function(u){var q=0,m=0,o=0,k=0,s=false,l=[],t=null,n=null,r=null;f();for(q=0,m=d.players.length;q<m;q++){e(d.players[q]);for(o=0,k=d.players[q].buildings.length;o<k;o++){c(d.players[q].buildings[o])}for(o=0,k=d.players[q].bullets.length;o<k;o++){h(d.players[q].bullets[o]);if(u===true){s=d.players[q].bullets[o].move();if(!s){l.push({p:q,b:o})}}}for(o=0,k=l.length;o<k;o++){t=l[o];d.players[t.p].bullets.splice(t.b,1)}l=[]}if(u&&!s){this.animatable=false}r=d.collisionHelper.processCollision(d.players);if(r){this.animatable=false;d.cpu.stop();d.showWinner(r.src.name=="1");window.document.body.onkeydown=undefined;window.document.body.onmousemove=undefined;window.document.body.onclick=function(){location.reload()}}dq("#score").textContent="Score: "+d.players[0].score+" - "+d.players[1].score};this.expand=function(l,m){var j=game.common.getBrowserLimits().width*0.9,k=game.common.getBrowserLimits().height*0.9,n=dq("#mainWrapper");k-=k%m;j-=j%m;dq("#"+l).style.width=j+"px";dq("#"+l).style.height=k+"px";d.canvasElement.width=j;d.canvasElement.height=k;d.canvasElement.style.width=j+"px";d.canvasElement.style.height=k+"px";n.style.width=j+"px";n.style.height=k+"px"};this.animate=function(j){d.draw(j);if(d.animatable===true){window.requestAnimFrame(function(){d.animate(j)})}};this.showPresentation=function(){var j=this.canvasElement.width/2,l=[];l.push({text:"[ Clash of Elements ]",size:"32",posY:0.15});l.push({text:"RULES:",size:"24",posY:0.25});l.push({text:"You will fight (from the left top corner) with a gun against your enemy",posY:0.35});l.push({text:"in the opposite corner, your objective is demolish all",posY:0.39});l.push({text:"their buildings (made of earth and air) with the elements (water, fire)",posY:0.43});l.push({text:"using your keys (W, R) respectively, and the mouse to aim, ",posY:0.47});l.push({text:"you can only fire 5 bullets at time, ",posY:0.51});l.push({text:"and then, when no enemy buildings, attack directly to win :D",posY:0.55});l.push({text:"Where:",posY:0.65});l.push({text:"[earth] get over [fire]",posY:0.69});l.push({text:"[water] get over [earth]",posY:0.73});l.push({text:"[air] get over [water]",posY:0.77});l.push({text:"[fire] get over [air]",posY:0.81});a.fillStyle="white";a.textAlign="center";for(var k=0;k<l.length;k++){a.font=l[k].size+"px Arial";a.fillText(l[k].text,j,this.canvasElement.height*l[k].posY)}};this.showWinner=function(k){var j=this.canvasElement.width/2,m=[];if(k){m.push({text:"YOU WIN !",size:"32",posY:0.4})}else{m.push({text:"YOU LOOSE !",size:"32",posY:0.4})}m.push({text:"Do you want to play again ?",size:"32",posY:0.5});m.push({text:"Click here to re-start",posY:0.6});a.fillStyle="yellow";a.textAlign="center";for(var l=0;l<m.length;l++){a.font=m[l].size+"px Arial";a.fillText(m[l].text,j,this.canvasElement.height*m[l].posY)}}}function f(){a.clearRect(0,0,d.canvasElement.width,d.canvasElement.height)}function e(j){var l=(j.height/2),k=(j.height/2);a.save();a.translate(j.x+l,j.y+k);a.rotate(j.angle*Math.PI/180);if(j.imageSrc){a.drawImage(j.getImage(),0,0,j.width,j.height,-l,-k,j.width,j.height)}else{g(p)}a.restore()}function c(j){if(j.imageSrc){a.drawImage(j.getImage(),j.width*j.typeNumber,0,j.width,j.height,j.x,j.y,j.width,j.height)}else{g(j)}}function h(j){i(j)}function g(j){a.beginPath();a.rect(-axisX,-axisY,pPlayer.width,pPlayer.height);a.fillStyle=pPlayer.fill;a.fill();a.lineWidth=1;a.strokeStyle=pPlayer.border;a.stroke()}function i(k){a.beginPath();a.arc(k.x+(k.width/2),k.y+(k.height/2),k.width/2,0,2*Math.PI,false);if(k.fillGradient){var j=a.createRadialGradient(k.x+(k.width/2),k.y+(k.height/2),0,k.x+(k.width/2),k.y+(k.height/2),k.width/2);j.addColorStop(0,k.fillGradient[0]);j.addColorStop(1,k.fillGradient[1]);a.fillStyle=j}else{a.fillStyle=k.fill}a.fill();a.lineWidth=1;a.strokeStyle=k.border;a.stroke()}return b})();game.CPU=(function(){var a=a;function b(){var d=this;this.cpu_interval=null,this.initial_timer=null,this.current_timer=null,this.final_timer=null,this.refresh=null;this.start=function(e){if(e){d.current_timer=e.initial_timer;d.final_timer=e.final_timer;d.refresh=e.refresh}d.cpu_interval=setInterval(function(){c(e)},d.current_timer);setInterval(function(){if(d.current_timer>d.final_timer){d.current_timer-=500;clearInterval(d.cpu_interval);d.cpu_interval=setInterval(function(){c(e)},d.current_timer)}},d.refresh)};this.stop=function(){clearInterval(d.cpu_interval)}}function c(i){var h=i.canvas.players[1];var e=i.canvas.players[0];var g=e.buildings[Math.floor((Math.random()*e.buildings.length))];if(g){h.onMouseMove({x:g.x,y:g.y})}else{h.onMouseMove({x:e.x,y:e.y})}h.getAngle(h.getCursor().x,h.getCursor().y);i.canvas.draw(false);var d=Math.floor((Math.random()*4)+1);var j=null;if(d==1||d==4||d==3||d==2){var f=Math.floor((Math.random()*5)+1);if(f==3||f==5){f=h.keys.earth;j="shootEarth"}else{f=h.keys.air;j="shootAir"}result=h.onKeyDown({event:{keyCode:f},_maxAmmo:i.maxAmmo});if(result&&result===true&&typeof result==="boolean"){i.sound.play(j);if(i.canvas.animatable===false){i.canvas.animatable=true;i.canvas.animate(true)}}}}return b})();game.sound=(function(){function b(){this.context=null;this.bufferLoader=null;this.init=function(){window.AudioContext=window.AudioContext||window.webkitAudioContext;this.context=new AudioContext();this.bufferLoader=new BufferLoader(this.context,{shootAir:"sfx/shootAir.mp3",shootFire:"sfx/shootFire.mp3",shootEarth:"sfx/shootEarth.mp3",shootWater:"sfx/shootWater.mp3"},a);this.bufferLoader.load()};this.play=function(d){var c=this.context.createBufferSource();c.buffer=this.bufferLoader.bufferList[d];c.connect(this.context.destination);c.start(0)}}function a(c){console.log("Sfx Loaded")}return b})();function BufferLoader(b,a,c){this.context=b;this.urlList=a;this.onload=c;this.bufferList={};this.loadCount=0}BufferLoader.prototype.loadBuffer=function(c,b){var d=new XMLHttpRequest();d.open("GET",c,true);d.responseType="arraybuffer";var a=this;d.onload=function(){a.context.decodeAudioData(d.response,function(f){var g,e=0;for(g in a.urlList){if(a.urlList.hasOwnProperty(g)){e++}}if(!f){alert("error decoding file data: "+c);return}a.bufferList[b]=f;if(++a.loadCount==e){a.onload(a.bufferList)}},function(e){console.error("decodeAudioData error",e)})};d.onerror=function(){alert("BufferLoader: XHR error")};d.send()};BufferLoader.prototype.load=function(){var a=0;for(var b in this.urlList){this.loadBuffer(this.urlList[b],b)}};game.collisionHelper=(function(){function a(){this.processCollision=function(n){var k=e(n),r=f(k),m=null;for(var l=0;l<r.length;l++){var q=r[l],o=null;if(j(q,"bullet","build")){o=b(q.item1,q.item2);if(q.item1.is==="bullet"){if(o.id==q.item1.id){d(q.item2);h(q.item1);q.item1.parent.src.score++}else{if(o.id==q.item2.id){h(q.item1)}}}else{if(q.item1.is==="build"){if(o.id==q.item1.id){h(q.item2)}else{if(o.id==q.item2.id){d(q.item1);h(q.item2);q.item2.parent.src.score++}}}}}if(j(q,"bullet","bullet")){o=b(q.item1,q.item2);if(o.id==q.item1.id){h(q.item2)}else{if(o.id==q.item2.id){h(q.item1)}}}if(j(q,"bullet","player")){if(q.item1.is==="bullet"){if(q.item2.src.buildings.length==0){m=q.item1.parent}h(q.item1)}if(q.item2.is==="bullet"){if(q.item1.src.buildings.length==0){m=q.item2.parent}d(q.item2)}}}return m};function e(o){var k=[];for(var n=0,m=o.length;n<m;n++){var l=i({item:o[n],is:"player",i:n,parent:null});k.push(l);k=k.concat(g({items:o[n].bullets,is:"bullet",parent:l}));k=k.concat(g({items:o[n].buildings,is:"build",parent:l}))}return k}function g(n){var k=[];for(var m=0,l=n.items.length;m<l;m++){k.push(i({item:n.items[m],is:n.is,i:m,parent:n.parent,type:n.items[m].type}))}return k}function i(k){return{x:k.item.x,y:k.item.y,width:k.item.width,height:k.item.height,is:k.is,index:k.i,parent:k.parent,id:k.item.id,type:k.type,src:k.item}}function f(o){var n=[],q=[];for(var l=0,k=o.length;l<k;l++){var m=o[l];q=dq.grep(o,function(r){return c(m,r)&&(r.id!=m.id)&&((m.parent==null||r.parent==null)||(m.parent.id!=r.parent.id))&&(r.parent==null||(m.id!=r.parent.id))&&(m.parent==null||(r.id!=m.parent.id))})[0];if(q){if(dq.grep(n,function(r){return r.item1.id===m.id||r.item1.id===q.id||r.item2.id===m.id||r.item2.id===q.id}).length===0){n.push({item1:m,item2:q})}}}return n}function c(q,n){var o={radius:q.height/2,x:q.x+(q.width/2),y:q.y+(q.height/2)},m={radius:n.height/2,x:n.x+(n.width/2),y:n.y+(n.height/2)};var l=o.x-m.x;var k=o.y-m.y;var r=Math.sqrt(l*l+k*k);return(r<o.radius+m.radius)}function j(k,m,l){return(k.item1.is==m&&k.item2.is==l||k.item1.is==l&&k.item2.is==m)}function h(m){if(m&&m.parent){for(var l=0,k=m.parent.src.bullets.length;l<k;l++){if(m.parent.src.bullets[l]&&m.parent.src.bullets[l].id===m.id){m.parent.src.bullets.splice(l,1)}}}}function d(m){if(m&&m.parent){for(var l=0,k=m.parent.src.buildings.length;l<k;l++){if(m.parent.src.buildings[l]&&m.parent.src.buildings[l].id===m.id){m.parent.src.buildings.splice(l,1)}}}}function b(l,k){if((l.type==="earth"&&k.type==="fire")||(l.type==="water"&&k.type==="earth")||(l.type==="air"&&k.type==="water")||(l.type==="fire"&&k.type==="air")){return l}else{if((k.type==="earth"&&l.type==="fire")||(k.type==="water"&&l.type==="earth")||(k.type==="air"&&l.type==="water")||(k.type==="fire"&&l.type==="air")){return k}}}}return a})();window.onload=function(){var a=new game();a.init({canvasWrapper:"canvasWrapper",canvasId:"canvasGame"})};